<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <link rel="stylesheet" href="/main.fb95afec182adbd07d4dc08912c704a858385a266b7260132c77247f747ebc02a468df8256883077d5adeefe15a59bee557daa19b4698c2a1dee8280b582efbe.css" integrity="sha512-&#43;5Wv7Bgq29B9TcCJEscEqFg4WiZrcmATLHckf3R&#43;vAKkaN&#43;CVogwd9Wt7v4VpZvuVX2qGbRpjCod7oKAtYLvvg==" crossorigin="anonymous">
<noscript><style>img.lazyload { display: none; }</style></noscript>

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">

  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  <title>How it works - Litestream</title>
<meta name="description" content="Litestream replicates SQLite databases in real-time to S3.">
<link rel="canonical" href="https://litestream.io/how-it-works/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://litestream.io/images/twitter-image.png">
<meta name="twitter:title" content="How it works">
<meta name="twitter:description" content="Litestream replicates SQLite databases in real-time to S3.">
<meta name="twitter:site" content="@litestreamio">
<meta name="twitter:creator" content="@benbjohnson">

<meta name="twitter:site" content="@litestreamio">
<meta name="twitter:creator" content="@benbjohnson">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position":  1 ,
        "name": "Home",
        "item": "https:\/\/litestream.io\/"
    },{
        "@type": "ListItem",
        "position":  2 ,
        "name": "How It Works",
        "item": "https:\/\/litestream.io\/how-it-works\/"
    }]
}
</script>

  <meta name="theme-color" content="#fff">
<link rel="apple-touch-icon" sizes="180x180" href="https://litestream.io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://litestream.io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://litestream.io/favicon-16x16.png">
<link rel="manifest" href="https://litestream.io/site.webmanifest">
  
</head>
  <body class="how-it-works list">
    <header class="navbar fixed-top navbar-expand-md navbar-light">
  <div class="container align-items-baseline">
    <input class="menu-btn order-0" type="checkbox" id="menu-btn">

    <label class="menu-icon d-md-none" for="menu-btn"><span class="navicon"></span></label>

    <a class="navbar-brand order-1 order-md-0 mr-auto" href="https://litestream.io/">
      <img class="d-md-inline d-none" src="/images/logo.svg" />
      <span class="d-sm-inline d-md-none">Litestream</span>
    </a>

    <ul class="navbar-nav social-nav order-3 order-md-5">
      <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/litestreamio"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><span class="ml-2 sr-only">Twitter</span></a>
        </li>
      <li class="nav-item">
          <a class="nav-link" href="https://github.com/benbjohnson/litestream"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ml-2 sr-only">GitHub</span></a>
        </li>
      </ul>

    <div class="collapse navbar-collapse order-4 order-md-1">
      <ul class="navbar-nav main-nav mr-auto order-5 order-md-2"><li class="nav-item">
            <a class="nav-link" href="https://litestream.io/install">Install</a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="https://litestream.io/guides">Guides</a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="https://litestream.io/reference">Reference</a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="https://litestream.io/blog/">Blog</a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="https://github.com/benbjohnson/litestream">GitHub</a>
          </li>
        <li class="nav-item">
            <a class="nav-link" href="https://join.slack.com/t/litestream/shared_invite/zt-n0j4s3ci-lx1JziR3bV6L2NMF723H3Q">Slack</a>
          </li>
        </ul>
      <div class="break order-6 d-md-none"></div>
    </div>
  </div>
</header>
    <div class="wrap container" role="document">
      <div class="content">
        
	<div class="row flex-xl-nowrap">
		<div class="col-lg-5 col-xl-4 docs-sidebar">
			<nav class="docs-links" aria-label="Main navigation">
				<h3>
    <a href="https://litestream.io/install">Install</a>
  </h3>
  <ul class="list-unstyled">
    <li><a class="docs-link" href="https://litestream.io/install/mac/">macOS</a></li>
    <li><a class="docs-link" href="https://litestream.io/install/debian/">Linux (Debian)</a></li>
    <li><a class="docs-link" href="https://litestream.io/install/source/">Build from Source</a></li>
    </ul>
  <h3>
    <a href="https://litestream.io/">General</a>
  </h3>
  <ul class="list-unstyled">
    <li><a class="docs-link" href="https://litestream.io/getting-started/">Getting Started</a></li>
    <li><a class="docs-link" href="https://litestream.io/tips/">Tips &amp; Caveats</a></li>
    <li><a class="docs-link active" href="https://litestream.io/how-it-works/">How it works</a></li>
    <li><a class="docs-link" href="https://litestream.io/alternatives/">Alternatives</a></li>
    </ul>
  <h3>
    <a href="https://litestream.io/guides/">Infrastructure Guides</a>
  </h3>
  <ul class="list-unstyled">
    <li><a class="docs-link" href="https://litestream.io/guides/docker/">Running in a Docker container</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/kubernetes/">Running in a Kubernetes cluster</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/systemd/">Running as a Systemd service</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/windows/">Running as a Windows Service</a></li>
    </ul>
  <h3>
    <a href="https://litestream.io/guides/">Replica Guides</a>
  </h3>
  <ul class="list-unstyled">
    <li><a class="docs-link" href="https://litestream.io/guides/s3/">Replicating to Amazon S3</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/azure/">Replicating to Azure Blob Storage</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/backblaze/">Replicating to Backblaze B2</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/digitalocean/">Replicating to DigitalOcean Spaces</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/scaleway/">Replicating to Scaleway Object Storage</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/gcs/">Replicating to Google Cloud Storage</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/linode/">Replicating to Linode Object Storage</a></li>
    <li><a class="docs-link" href="https://litestream.io/guides/sftp/">Replicating to an SFTP Server</a></li>
    </ul>
  <h3>
    <a href="https://litestream.io/reference/">Reference</a>
  </h3>
  <ul class="list-unstyled">
    <li><a class="docs-link" href="https://litestream.io/reference/config/">Configuration File</a></li>
    <li><a class="docs-link" href="https://litestream.io/reference/databases/">Command: databases</a></li>
    <li><a class="docs-link" href="https://litestream.io/reference/generations/">Command: generations</a></li>
    <li><a class="docs-link" href="https://litestream.io/reference/replicate/">Command: replicate</a></li>
    <li><a class="docs-link" href="https://litestream.io/reference/restore/">Command: restore</a></li>
    <li><a class="docs-link" href="https://litestream.io/reference/snapshots/">Command: snapshots</a></li>
    <li><a class="docs-link" href="https://litestream.io/reference/version/">Command: version</a></li>
    <li><a class="docs-link" href="https://litestream.io/reference/wal/">Command: wal</a></li>
    </ul>
  
			</nav>        
		</div>
		<nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation">
			<div class="page-links">
    <h3>On this page</h3>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#understanding-the-wal">Understanding the WAL</a></li>
    <li><a href="#the-shadow-wal">The shadow WAL</a></li>
    <li><a href="#snapshots--generations">Snapshots &amp; generations</a></li>
    <li><a href="#retention">Retention</a></li>
  </ul>
</nav>
  </div>

		</nav>
		<main class="docs-content col-lg-11 col-xl-9 mx-xl-auto">
		<h1>How it works</h1>
			<p class="lead"></p>
			<p>Litestream is a streaming replication tool for SQLite databases. It runs as a
separate background process and continuously copies write-ahead log pages from
disk to one or more replicas. This asynchronous replication provides disaster
recovery similar to what is available with database servers like Postgres or
MySQL.</p>
<h2 id="understanding-the-wal">Understanding the WAL<a href="#understanding-the-wal" class="anchor" aria-hidden="true">#</a> </h2>
<p>SQLite has a journaling mode called &ldquo;WAL&rdquo; (write-ahead log) which writes
database page changes to a separate <code>-wal</code> file first before later copying
those pages back into the main database file. This lets SQLite provide safe,
atomic transactions because it can simply delete WAL pages if a transaction gets
rolled back. If pages were written directly to the database file then there
would be no way to get back the original page data on rollback.</p>
<p>The WAL also allows read transactions to have their own snapshot view of the
database at the time the transaction started because there can be multiple
instances of the same database page spread across the database file &amp; WAL.</p>
<p>However, the WAL continually grows so eventually pages have to be moved back to
the database file so the WAL can be restarted. This process is called
<em>checkpointing</em> and can only be done when no transactions are active. That is
the crux of what lets Litestream replicate SQLite.</p>
<h2 id="the-shadow-wal">The shadow WAL<a href="#the-shadow-wal" class="anchor" aria-hidden="true">#</a> </h2>
<p>Litestream works by effectively taking over the checkpointing process. It starts
a long-running read transaction to prevent any other process from checkpointing
and restarting the WAL file. Instead, it continually copies over new WAL pages
to a staging area called the <em>shadow WAL</em> and manually calls out to SQLite to
perform checkpoints as necessary.</p>
<p>The shadow WAL is a directory next to your SQLite database where WAL files are
effectively recreated as a sequence. The first shadow WAL file starts with
<code>00000000.wal</code> and when a checkpoint occurs then it starts copying to
<code>00000001.wal</code>.</p>
<p>These WAL files contain the original WAL frames &amp; checksums to ensure
consistency. To restore a database, we can simply start from a snapshot of the
database at some point in time and replay each WAL afterward to get it to the
current state.</p>
<h2 id="snapshots--generations">Snapshots &amp; generations<a href="#snapshots--generations" class="anchor" aria-hidden="true">#</a> </h2>
<p>In order to accurately restore a database, a snapshot and all subsequent WAL
frames must be available. Any break in the WAL frames would result in a
corrupted restored database file. This collection of snapshots &amp; contiguous
WAL files is called a <em>generation</em> in Litestream.</p>
<p>When Litestream first starts replicating a database, it creates a new
generation. This is simply a 16-character random hex string. A snapshot is
created by copying the current state of the database and then all WAL files
created after are named as 8-character incrementing hex values starting with
zero.</p>
<p>If Litestream detects that there is a break in the WAL frames then it will
automatically start a new generation with a new random hex string and a
snapshot. This ensures we always have a contiguous set of files to replay even
if Litestream is stopped and misses WAL frames being written.</p>
<p>This approach also has the benefit that two servers that accidentally share
the same replica destination will not overwrite each other&rsquo;s data. However,
note that it is not recommended to replicate two databases to the same exact
replica path.</p>
<h2 id="retention">Retention<a href="#retention" class="anchor" aria-hidden="true">#</a> </h2>
<p>The time to restore a database from backup is directly related to the number and
size of WAL files since the snapshot. To avoid having the WAL files grow without
bound, Litestream performs new snapshots of the data periodically and removes old
WAL files.</p>
<p>This process is broken up into two steps. First, a snapshot interval is set to
re-snapshot the database on a regular basis. This allows you to keep copies of
your database at multiple points in time.</p>
<p>The second step is retention enforcement. This periodically runs and removes any
snapshots older than the retention time as well as remove any WAL files older
than the oldest snapshot. By default, this the retention time is 24 hours.
Litestream will always ensure there is at least one snapshot retained.</p>
<p>This two-step process allows for more use cases such as snapshotting every day
but retaining snapshots for a week.</p>

			
		</main>
	</div>

      </div>
    </div>
    
    
    <footer>
</footer>
    
    <script src="https://litestream.io/main.f4006b8dd3163d19fa41adf9892089fe185101b404b96884ed2a22ec4e9cb0706759ecdb3f4520a1d37fc5ad7a90a8d90abfb30055a1ff67aefb5b2324355d12.js" integrity="sha512-9ABrjdMWPRn6Qa35iSCJ/hhRAbQEuWiE7Soi7E6csHBnWezbP0UgodN/xa16kKjZCr&#43;zAFWh/2eu&#43;1sjJDVdEg==" crossorigin="anonymous" defer></script>
  <script src="https://litestream.io/index.min.0e659944585b7f34b65dc5c6889aecade6086326d0a1120401218997ba56299c29f87e5c13c0424fdfa2f2b825a6407d1c352169134255e300c0f80614b6c93e.js" integrity="sha512-DmWZRFhbfzS2XcXGiJrsreYIYybQoRIEASGJl7pWKZwp&#43;H5cE8BCT9&#43;i8rglpkB9HDUhaRNCVeMAwPgGFLbJPg==" crossorigin="anonymous" defer></script>

  </body>
</html>