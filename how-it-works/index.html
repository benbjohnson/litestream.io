<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=https://litestream.io/main.1dfb1181b76059f7055864fc35293b1687b2cc9ee1c98c857034bf65632ebe277ff6e04930ee2aace0c20516f5a27ab7f338a2492820b2f4814ff0fd699cf722.css integrity="sha512-HfsRgbdgWfcFWGT8NSk7FoeyzJ7hyYyFcDS/ZWMuvid/9uBJMO4qrODCBRb1onq38ziiSSggsvSBT/D9aZz3Ig==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel=stylesheet><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>How it works - Litestream</title><meta name=description content="Litestream replicates SQLite databases in real-time to S3."><link rel=canonical href=https://litestream.io/how-it-works/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://litestream.io/images/twitter-image.png"><meta name=twitter:title content="How it works"><meta name=twitter:description content="Litestream replicates SQLite databases in real-time to S3."><meta name=twitter:site content="@litestreamio"><meta name=twitter:creator content="@benbjohnson"><meta name=twitter:site content="@litestreamio"><meta name=twitter:creator content="@benbjohnson"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/litestream.io\/"},{"@type":"ListItem","position":2,"name":"How It Works","item":"https:\/\/litestream.io\/how-it-works\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://litestream.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://litestream.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://litestream.io/favicon-16x16.png><link rel=manifest href=https://litestream.io/site.webmanifest></head><body class="how-it-works list"><header class="navbar fixed-top navbar-expand-md navbar-light"><div class="container align-items-baseline"><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 mr-auto" href=https://litestream.io/>Litestream</a><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://twitter.com/litestreamio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><span class="ml-2 sr-only">Twitter</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/benbjohnson/litestream><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ml-2 sr-only">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav mr-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://litestream.io/install>Install</a></li><li class=nav-item><a class=nav-link href=https://litestream.io/guides>Guides</a></li><li class=nav-item><a class=nav-link href=https://litestream.io/reference>Reference</a></li><li class=nav-item><a class=nav-link href=https://litestream.io/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://github.com/benbjohnson/litestream>GitHub</a></li><li class=nav-item><a class=nav-link href=https://join.slack.com/t/litestream/shared_invite/zt-n0j4s3ci-lx1JziR3bV6L2NMF723H3Q>Slack</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3><a href=https://litestream.io/install>Install</a></h3><ul class=list-unstyled><li><a class=docs-link href=https://litestream.io/install/mac/>macOS</a></li><li><a class=docs-link href=https://litestream.io/install/debian/>Linux (Debian)</a></li><li><a class=docs-link href=https://litestream.io/install/source/>Build from Source</a></li></ul><h3><a href=https://litestream.io/getting-started/>Getting Started</a></h3><h3><a href=https://litestream.io/tips/>Tips & Caveats</a></h3><h3><a href=https://litestream.io/guides/>Guides</a></h3><ul class=list-unstyled><li><a class=docs-link href=https://litestream.io/guides/systemd/>Running as a Systemd service</a></li><li><a class=docs-link href=https://litestream.io/guides/windows/>Running as a Windows Service</a></li><li><a class=docs-link href=https://litestream.io/guides/s3/>Replicating to Amazon S3</a></li><li><a class=docs-link href=https://litestream.io/guides/backblaze-b2/>Replicating to Backblaze B2</a></li><li><a class=docs-link href=https://litestream.io/guides/digitalocean/>Replicating to DigitalOcean Spaces</a></li><li><a class=docs-link href=https://litestream.io/guides/linode/>Replicating to Linode Object Storage</a></li></ul><h3><a href=https://litestream.io/how-it-works/>How it Works</a></h3><h3><a href=https://litestream.io/reference/>Reference</a></h3><ul class=list-unstyled><li><a class=docs-link href=https://litestream.io/reference/config/>Configuration File</a></li><li><a class=docs-link href=https://litestream.io/reference/databases/>Command: databases</a></li><li><a class=docs-link href=https://litestream.io/reference/generations/>Command: generations</a></li><li><a class=docs-link href=https://litestream.io/reference/replicate/>Command: replicate</a></li><li><a class=docs-link href=https://litestream.io/reference/restore/>Command: restore</a></li><li><a class=docs-link href=https://litestream.io/reference/snapshots/>Command: snapshots</a></li><li><a class=docs-link href=https://litestream.io/reference/version/>Command: version</a></li><li><a class=docs-link href=https://litestream.io/reference/wal/>Command: wal</a></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#understanding-the-wal>Understanding the WAL</a></li><li><a href=#the-shadow-wal>The shadow WAL</a></li><li><a href=#snapshots--generations>Snapshots & generations</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>How it works</h1><p class=lead></p><p>Litestream is a streaming replication tool for SQLite databases. It runs as a
separate background process and continuously copies write-ahead log pages from
disk to one or more replicas. This asynchronous replication provides disaster
recovery similar to what is available with database servers like Postgres or
MySQL.</p><h2 id=understanding-the-wal>Understanding the WAL<a href=#understanding-the-wal class=anchor aria-hidden=true>#</a></h2><p>SQLite has a journaling mode called &ldquo;WAL&rdquo; (write-ahead log) which writes
database page changes to a separate <code>-wal</code> file first before later copying
those pages back into the main database file. This lets SQLite provide safe,
atomic transactions because it can simply delete WAL pages if a transaction gets
rolled back. If pages were written directly to the database file then there
would be no way to get back the original page data on rollback.</p><p>The WAL also allows read transactions have their own snapshot view of the
database at the time the transaction started because there can be multiple
instances of the same database page spread across the database file & WAL.</p><p>However, the WAL continually grows so eventually pages have to be moved back to
the database file so the WAL can be restarted. This process is called
<em>checkpointing</em> and can only be done when no transactions are active. That is
the crux of what lets Litestream replicate SQLite.</p><h2 id=the-shadow-wal>The shadow WAL<a href=#the-shadow-wal class=anchor aria-hidden=true>#</a></h2><p>Litestream works by effectively taking over the checkpointing process. It starts
a long-running read transaction to prevent any other process from checkpointing
and restarting the WAL file. Instead, it continually copies over new WAL pages
to a staging area called the <em>shadow WAL</em> and manually calls out to SQLite to
perform checkpoints as necessary.</p><p>The shadow WAL is a directory next to your SQLite database where WAL files are
effectively recreated as a sequence. The first shadow WAL file starts with
<code>00000000.wal</code> and when a checkpoint occurs then it starts copying to
<code>00000001.wal</code>.</p><p>These WAL files contain the original WAL frames & checksums to ensure
consistency. To restore a database, we can simply start from a snapshot of the
database at some point in time and replay each WAL afterward to get it to the
current state.</p><h2 id=snapshots--generations>Snapshots & generations<a href=#snapshots--generations class=anchor aria-hidden=true>#</a></h2><p>In order to accurately restore a database, a snapshot and all subsequent WAL
frames must be available. Any break in the WAL frames would result in a
corrupted restored database file. This collection of snapshots & contiguous
WAL files is called a <em>generation</em> in Litestream.</p><p>When Litestream first starts replicating a database, it creates a new
generation. This is simply a 16-character random hex string. A snapshot is
created by copying the current state of the database and then all WAL files
created after are named as 8-character incrementing hex values starting with
zero.</p><p>If Litestream detects that there is a break in the WAL frames then it will
automatically start a new generation with a new random hex string and a
snapshot. This ensures we always have a contiguous set of files to replay even
if Litestream is stopped and misses WAL frames being written.</p><p>This approach also has the benefit that two servers that accidentally share
the same replica destination will not overwrite each other&rsquo;s data. However,
note that it is not recommended to replicate two databases to the same exact
replica path.</p></main></div></div></div><footer></footer><script src=https://litestream.io/main.f6b484f556ad1f3bcf6061082139a2f21fa759f13930c39a25fe4a9f78f35e64122c2d86dffd56e67b292dabbda4095d8077194f196e0e348441c106a9f3d40e.js integrity="sha512-9rSE9VatHzvPYGEIITmi8h+nWfE5MMOaJf5Kn3jzXmQSLC2G3/1W5nspLau9pAldgHcZTxluDjSEQcEGqfPUDg==" crossorigin=anonymous defer></script><script src=https://litestream.io/index.min.3cf72e2d46fb5e5ef4c137f33b9a80ab66cb3d96bc8451412b740d90917bb1d3f5f511faa6358f78f6c5b4610e34b9f0a696d9a355e8ed0e55884a6267cf452c.js integrity="sha512-PPcuLUb7Xl70wTfzO5qAq2bLPZa8hFFBK3QNkJF7sdP19RH6pjWPePbFtGEONLnwppbZo1Xo7Q5ViEpiZ89FLA==" crossorigin=anonymous defer></script></body></html>